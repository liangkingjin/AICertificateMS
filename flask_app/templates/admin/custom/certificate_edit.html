{% extends 'admin/base.html' %}

{% block title %}ç¼–è¾‘è¯ä¹¦ - è¯ä¹¦ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}ç¼–è¾‘è¯ä¹¦{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="#">è¯ä¹¦ç®¡ç†</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('my_certs.index') }}">æˆ‘çš„è¯ä¹¦</a></li>
<li class="breadcrumb-item active">ç¼–è¾‘</li>
{% endblock %}

{% block body %}
<div class="row">
    <!-- å·¦ä¾§ï¼šè¯ä¹¦æ–‡ä»¶é¢„è§ˆ -->
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-image"></i> è¯ä¹¦æ–‡ä»¶</h3>
            </div>
            <div class="card-body text-center">
                {% if cert.file_path %}
                    {% if cert.file_path.lower().endswith(('.jpg', '.jpeg', '.png', '.bmp')) %}
                    <img src="{{ url_for('api.get_certificate_file', cert_id=cert.cert_id) }}"
                        alt="è¯ä¹¦å›¾ç‰‡" class="img-fluid" style="max-height: 500px;">
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-file-pdf fa-3x"></i>
                        <p class="mt-2 mb-0">PDFæ–‡ä»¶</p>
                        <a href="{{ url_for('api.get_certificate_file', cert_id=cert.cert_id) }}" target="_blank" class="btn btn-sm btn-primary mt-2">
                            <i class="fas fa-external-link-alt"></i> æ‰“å¼€æŸ¥çœ‹
                        </a>
                    </div>
                    {% endif %}
                {% else %}
                <div class="text-muted">
                    <i class="fas fa-image fa-3x"></i>
                    <p class="mt-2 mb-0">æš‚æ— è¯ä¹¦æ–‡ä»¶</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- è¯ä¹¦åŸºæœ¬ä¿¡æ¯ -->
        <div class="card card-secondary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h3>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">å½“å‰çŠ¶æ€</dt>
                    <dd class="col-sm-8">
                        {% if cert.status == 'draft' %}
                        <span class="badge badge-warning">ğŸ“ è‰ç¨¿</span>
                        {% elif cert.status == 'pending_teacher' %}
                        <span class="badge badge-info">â³ å¾…æ•™å¸ˆå®¡æ ¸</span>
                        {% elif cert.status == 'pending_admin' %}
                        <span class="badge badge-primary">â³ å¾…ç®¡ç†å‘˜å®¡æ ¸</span>
                        {% elif cert.status == 'approved' %}
                        <span class="badge badge-success">âœ… å®¡æ ¸é€šè¿‡</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ cert.status }}</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-4">åˆ›å»ºæ—¶é—´</dt>
                    <dd class="col-sm-8">{{ cert.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>

                    {% if current_user.role not in ['student'] %}
                    <dt class="col-sm-4">æ ‡å‡†åˆ†å€¼</dt>
                    <dd class="col-sm-8">
                        {% if cert.standard_score %}
                        <span class="badge badge-primary">{{ cert.standard_score }}</span>
                        {% else %}
                        <span class="text-muted">æœªè¯„åˆ†</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-4">è´¡çŒ®åº¦</dt>
                    <dd class="col-sm-8">
                        {% if cert.contribution %}
                        <span class="badge badge-success">{{ cert.contribution }}</span>
                        {% else %}
                        <span class="text-muted">æœªè¯„ä¼°</span>
                        {% endif %}
                    </dd>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šç¼–è¾‘è¡¨å• -->
    <div class="col-md-7">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-edit"></i> ç¼–è¾‘è¯ä¹¦ä¿¡æ¯</h3>
            </div>
            <form action="{{ url_for('my_certs.edit', cert_id=cert.cert_id) }}" method="post" id="certificateForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action_status" id="action_status" value="draft">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="student_id">å­¦å· <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="student_id" name="student_id"
                                    value="{{ cert.student_id }}" {% if current_user.role=='student' %}readonly{% endif %} required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="student_name">å­¦ç”Ÿå§“å <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="student_name" name="student_name"
                                    value="{{ cert.student_name }}" {% if current_user.role=='student' %}readonly{% endif %} required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="department">å­¦é™¢ <span class="text-danger">*</span></label>
                        <select class="form-control select2" id="department" name="department" required>
                            {% for value, label in colleges %}
                            <option value="{{ value }}" {% if cert.department==value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="competition_name">ç«èµ›é¡¹ç›® <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="competition_name" name="competition_name"
                            value="{{ cert.competition_name }}" required>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="award_category">è·å¥–ç±»åˆ« <span class="text-danger">*</span></label>
                                <select class="form-control select2" id="award_category" name="award_category" required>
                                    {% for value, label in categories %}
                                    <option value="{{ value }}" {% if cert.award_category==value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="award_level">è·å¥–ç­‰çº§ <span class="text-danger">*</span></label>
                                <select class="form-control select2" id="award_level" name="award_level" required>
                                    {% for value, label in levels %}
                                    <option value="{{ value }}" {% if cert.award_level==value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="competition_type">ç«èµ›ç±»å‹ <span class="text-danger">*</span></label>
                                <select class="form-control select2" id="competition_type" name="competition_type" required>
                                    {% for value, label in comp_types %}
                                    <option value="{{ value }}" {% if cert.competition_type==value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="organizer">ä¸»åŠå•ä½</label>
                                <input type="text" class="form-control" id="organizer" name="organizer"
                                    value="{{ cert.organizer }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="award_date">è·å¥–æ—¶é—´</label>
                                <input type="date" class="form-control" id="award_date" name="award_date" 
                                    value="{{ cert.award_date.strftime('%Y-%m-%d') if cert.award_date else '' }}">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="advisor">æŒ‡å¯¼æ•™å¸ˆ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="advisor" name="advisor"
                                    value="{{ cert.advisor }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="advisor_id">æŒ‡å¯¼è€å¸ˆå·¥å· <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="advisor_id" name="advisor_id"
                                    value="{{ cert.advisor_id or '' }}" placeholder="8ä½æ•°å­—" required>
                            </div>
                        </div>
                    </div>

                    {% if current_user.role not in ['student'] %}
                    <hr>
                    <h5><i class="fas fa-star text-warning"></i> è¯„åˆ†ä¿¡æ¯</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="standard_score">æ ‡å‡†åˆ†å€¼</label>
                                <select class="form-control select2" id="standard_score" name="standard_score">
                                    {% for value, label in standard_scores %}
                                    <option value="{{ value }}" {% if cert.standard_score and cert.standard_score == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="contribution">è´¡çŒ®åº¦</label>
                                <select class="form-control select2" id="contribution" name="contribution">
                                    {% for value, label in contributions %}
                                    <option value="{{ value }}" {% if cert.contribution and cert.contribution == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="card-footer">
                    <div class="row">
                        <div class="col-4">
                            <a href="{{ url_for('my_certs.index') }}" class="btn btn-secondary btn-block">
                                <i class="fas fa-arrow-left"></i> è¿”å›
                            </a>
                        </div>
                        {% if cert.status == 'draft' %}
                        <div class="col-4">
                            <button type="submit" class="btn btn-success btn-block" onclick="submitForm('submitted')">
                                <i class="fas fa-paper-plane"></i> æäº¤å®¡æ ¸
                            </button>
                        </div>
                        {% endif %}
                        <div class="col-4">
                            <button type="submit" class="btn btn-warning btn-block" onclick="submitForm('draft')">
                                <i class="fas fa-save"></i> ä¿å­˜è‰ç¨¿
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block tail_js %}
<script>
    $(document).ready(function() {
        $('.select2').select2({
            theme: 'bootstrap4',
            width: '100%'
        });

        {% if current_user.role not in ['student'] %}
        // æ‰‹åŠ¨è®¾ç½®è¯„åˆ†ä¿¡æ¯çš„é€‰ä¸­å€¼ï¼ˆè§£å†³ Select2 ä¸æ˜¾ç¤ºå·²é€‰ä¸­å€¼çš„é—®é¢˜ï¼‰
        var standardScore = '{{ cert.standard_score or "" }}';
        var contribution = '{{ cert.contribution or "" }}';

        // å»æ‰å°æ•°ç‚¹åçš„".0"ï¼Œä¾‹å¦‚ 30.0 -> 30
        if (standardScore && standardScore.endsWith('.0')) {
            standardScore = standardScore.slice(0, -2);
        }
        if (contribution && contribution.endsWith('.0')) {
            contribution = contribution.slice(0, -2);
        }

        if (standardScore) {
            $('#standard_score').val(standardScore).trigger('change');
        }
        if (contribution) {
            $('#contribution').val(contribution).trigger('change');
        }
        {% endif %}
    });

    // æäº¤è¡¨å•å‰è®¾ç½®çŠ¶æ€
    function submitForm(status) {
        document.getElementById('action_status').value = status;
        if (status === 'submitted') {
            return confirm('ç¡®å®šæäº¤å®¡æ ¸å—ï¼Ÿæäº¤åå°†è¿›å…¥æ•™å¸ˆå®¡æ ¸æµç¨‹ã€‚');
        }
        return true;
    }
</script>
{% endblock %}
