{% extends 'admin/base.html' %}

{% block title %}ä¸Šä¼ è¯ä¹¦ - è¯ä¹¦ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}ä¸Šä¼ è¯ä¹¦{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="#">è¯ä¹¦ç®¡ç†</a></li>
<li class="breadcrumb-item active">ä¸Šä¼ è¯ä¹¦</li>
{% endblock %}

{% block head_css %}
<style>
    /* Loading é®ç½©å±‚ */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .loading-content {
        text-align: center;
        color: white;
    }
    .loading-spinner {
        width: 80px;
        height: 80px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #28a745;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .loading-text {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .loading-subtext {
        font-size: 14px;
        color: #ccc;
    }
</style>
{% endblock %}

{% block body %}
<!-- Loading é®ç½©å±‚ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">æ­£åœ¨å¤„ç†ä¸­...</div>
        <div class="loading-subtext" id="loadingSubtext">è¯·ç¨å€™ï¼Œå³å°†å®Œæˆ</div>
    </div>
</div>

<!-- æˆªæ­¢æ—¶é—´æç¤º -->
{% if deadline %}
<div class="alert alert-info alert-dismissible fade show mb-3">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    <i class="fas fa-clock"></i> <strong>è¯ä¹¦æäº¤æˆªæ­¢æ—¶é—´ï¼š</strong>{{ deadline }}
    {% if is_overdue %}
    <span class="badge badge-danger ml-2">å·²æˆªæ­¢</span>
    {% else %}
    <span class="badge badge-success ml-2">å¯æäº¤</span>
    {% endif %}
</div>
{% endif %}

<div class="row">
    <!-- å·¦ä¾§ï¼šä¸Šä¼ åŒºåŸŸ -->
    <div class="col-md-5">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-upload"></i> ä¸Šä¼ è¯ä¹¦æ–‡ä»¶</h3>
            </div>
            <div class="card-body">
                {% if not extracted_info and not file_path %}
                <!-- ä¸Šä¼ è¡¨å• -->
                <form id="uploadForm" action="{{ url_for('cert_upload.index') }}" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="upload">

                    <div class="form-group">
                        <label for="certificate_file">é€‰æ‹©è¯ä¹¦æ–‡ä»¶</label>
                        <div class="input-group">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="certificate_file"
                                    name="certificate_file" accept=".jpg,.jpeg,.png,.bmp,.gif,.webp" required>
                                <label class="custom-file-label" for="certificate_file">é€‰æ‹©æ–‡ä»¶...</label>
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            æ”¯æŒæ ¼å¼ï¼šJPGã€JPEGã€PNGã€BMPã€GIFã€WEBPï¼Œæœ€å¤§10MB<br>
                            <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> PDFæ–‡ä»¶è¯·å…ˆè½¬æ¢ä¸ºå›¾ç‰‡å†ä¸Šä¼ </span>
                        </small>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-cloud-upload-alt"></i> ä¸Šä¼ æ–‡ä»¶
                    </button>
                </form>
                {% else %}
                <!-- æ–‡ä»¶å·²ä¸Šä¼ ï¼Œæ˜¾ç¤ºé¢„è§ˆå’ŒAIè¯†åˆ«æŒ‰é’® -->
                <div class="file-preview text-center mb-3">
                    {% if existing_cert %}
                    {# ç§’ä¼ æˆåŠŸï¼Œä½¿ç”¨APIè·¯ç”±é¢„è§ˆ #}
                    <img src="{{ url_for('api.get_certificate_file', cert_id=existing_cert.cert_id) }}"
                        alt="è¯ä¹¦é¢„è§ˆ" class="img-fluid" style="max-height: 300px;">
                    {% elif file_path %}
                    {# æ–°ä¸Šä¼ æ–‡ä»¶ï¼Œä½¿ç”¨å®‰å…¨APIè·¯ç”± #}
                    {% set relative_path = file_path.split('uploads')[-1].lstrip('\\').lstrip('/') if 'uploads' in file_path else '' %}
                    <img src="{{ url_for('api.get_uploaded_file', file_path=relative_path) if relative_path else '#' }}"
                        alt="è¯ä¹¦é¢„è§ˆ" class="img-fluid" style="max-height: 300px;">
                    {% endif %}
                </div>

                {% if not extracted_info %}
                <!-- AIè¯†åˆ«æŒ‰é’® -->
                <form id="extractForm" action="{{ url_for('cert_upload.index') }}" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="extract">
                    <input type="hidden" name="file_path" value="{{ file_path }}">
                    <input type="hidden" name="file_md5" value="{{ file_md5 }}">
                    <button type="submit" class="btn btn-success btn-block">
                        <i class="fas fa-robot"></i> AIè¯†åˆ«è¯ä¹¦ä¿¡æ¯
                    </button>
                </form>
                {% endif %}

                <!-- é‡æ–°ä¸Šä¼  -->
                <a href="{{ url_for('cert_upload.index') }}" class="btn btn-secondary btn-block mt-2">
                    <i class="fas fa-redo"></i> é‡æ–°ä¸Šä¼ 
                </a>
                {% endif %}
            </div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div class="card card-info">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h3>
            </div>
            <div class="card-body">
                <ol class="pl-3">
                    <li>ä¸Šä¼ è¯ä¹¦å›¾ç‰‡æ–‡ä»¶ï¼ˆæ”¯æŒ JPGã€PNGã€BMPã€GIFã€WEBPï¼‰</li>
                    <li>ç‚¹å‡»"AIè¯†åˆ«"è‡ªåŠ¨æå–ä¿¡æ¯</li>
                    <li>æ ¸å¯¹å¹¶ä¿®æ”¹è¯†åˆ«ç»“æœ</li>
                    <li>é€‰æ‹©ä¿å­˜ä¸ºè‰ç¨¿æˆ–ç›´æ¥æäº¤</li>
                </ol>
                <p class="text-warning mb-0">
                    <i class="fas fa-info-circle"></i> PDFæ–‡ä»¶è¯·ä½¿ç”¨æˆªå›¾å·¥å…·è½¬æ¢ä¸ºå›¾ç‰‡åä¸Šä¼ 
                </p>
                <p class="text-success mb-0 mt-2">
                    <i class="fas fa-bolt"></i> æ”¯æŒç§’ä¼ ï¼šç›¸åŒæ–‡ä»¶æ— éœ€é‡å¤ä¸Šä¼ å’Œè¯†åˆ«
                </p>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šä¿¡æ¯è¡¨å• -->
    <div class="col-md-7">
        <div class="card card-success">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-edit"></i> è¯ä¹¦ä¿¡æ¯</h3>
            </div>
            <form action="{{ url_for('cert_upload.index') }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="save">
                <input type="hidden" name="file_path" value="{{ file_path or '' }}">
                <input type="hidden" name="file_md5" value="{{ file_md5 or '' }}">
                {% if existing_cert %}
                <input type="hidden" name="existing_cert_id" value="{{ existing_cert.cert_id }}">
                {% endif %}

                <div class="card-body">
                    {% if is_quick_upload %}
                    <div class="alert {% if can_edit %}alert-info{% else %}alert-warning{% endif %}">
                        <i class="fas fa-bolt"></i> ç§’ä¼ æˆåŠŸï¼å·²åŠ è½½ä¹‹å‰ä¸Šä¼ çš„è¯ä¹¦ä¿¡æ¯
                        {% if not can_edit %}
                        <br><small><i class="fas fa-lock"></i> å½“å‰è¯ä¹¦çŠ¶æ€ä¸‹ä¸å¯ç¼–è¾‘ï¼Œä»…å¯æŸ¥çœ‹</small>
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="student_id">å­¦å· <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="student_id" name="student_id"
                                    value="{{ extracted_info.student_id if extracted_info else '' }}"
                                    {% if is_quick_upload and not can_edit %}readonly{% endif %} required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="student_name">å­¦ç”Ÿå§“å <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="student_name" name="student_name"
                                    value="{{ extracted_info.student_name if extracted_info else '' }}"
                                    {% if is_quick_upload and not can_edit %}readonly{% endif %} required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="department">å­¦é™¢ <span class="text-danger">*</span></label>
                        <select class="form-control select2" id="department" name="department" required {% if is_quick_upload and not can_edit %}disabled{% endif %}>
                            {% for value, label in colleges %}
                            <option value="{{ value }}" {% if extracted_info and
                                extracted_info.student_department==value %}selected{% endif %} {% if extracted_info and
                                extracted_info.department==value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="competition_name">ç«èµ›é¡¹ç›® <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="competition_name" name="competition_name"
                            value="{{ extracted_info.competition_name if extracted_info else '' }}" required {% if is_quick_upload and not can_edit %}readonly{% endif %}>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="award_category">è·å¥–ç±»åˆ« <span class="text-danger">*</span></label>
                                <select class="form-control" id="award_category" name="award_category" required {% if is_quick_upload and not can_edit %}disabled{% endif %}>
                                    {% for value, label in categories %}
                                    <option value="{{ value }}" {% if extracted_info and
                                        extracted_info.award_category==value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="award_level">è·å¥–ç­‰çº§ <span class="text-danger">*</span></label>
                                <select class="form-control" id="award_level" name="award_level" required {% if is_quick_upload and not can_edit %}disabled{% endif %}>
                                    {% for value, label in levels %}
                                    <option value="{{ value }}" {% if extracted_info and
                                        extracted_info.award_level==value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="competition_type">ç«èµ›ç±»å‹ <span class="text-danger">*</span></label>
                                <select class="form-control" id="competition_type" name="competition_type" required {% if is_quick_upload and not can_edit %}disabled{% endif %}>
                                    {% for value, label in comp_types %}
                                    <option value="{{ value }}" {% if extracted_info and
                                        extracted_info.competition_type==value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="organizer">ä¸»åŠå•ä½</label>
                                <input type="text" class="form-control" id="organizer" name="organizer"
                                    value="{{ extracted_info.organizer if extracted_info else '' }}" {% if is_quick_upload and not can_edit %}readonly{% endif %}>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="award_date">è·å¥–æ—¶é—´</label>
                                <input type="date" class="form-control" id="award_date" name="award_date" 
                                    value="{{ extracted_info.award_date if extracted_info and extracted_info.award_date else '' }}"
                                    {% if is_quick_upload and not can_edit %}readonly{% endif %} placeholder="è¯·é€‰æ‹©">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="advisor_id">æŒ‡å¯¼è€å¸ˆå·¥å· <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="advisor_id" name="advisor_id"
                                    value="{{ extracted_info.advisor_id if extracted_info else '' }}"
                                    {% if is_quick_upload and not can_edit %}readonly{% endif %} placeholder="8ä½æ•°å­—" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="advisor">æŒ‡å¯¼æ•™å¸ˆ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="advisor" name="advisor"
                                    value="{{ extracted_info.advisor if extracted_info else '' }}"
                                    {% if is_quick_upload and not can_edit %}readonly{% endif %} required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    {% if is_quick_upload and not can_edit %}
                    <div class="alert alert-info mb-2">
                        <i class="fas fa-info-circle"></i> è¯¥è¯ä¹¦å·²å­˜åœ¨ä¸”å½“å‰çŠ¶æ€ä¸å¯ç¼–è¾‘ï¼Œæ‚¨å¯ä»¥å‰å¾€â€œæˆ‘çš„è¯ä¹¦â€æŸ¥çœ‹è¯¦æƒ…
                    </div>
                    <a href="{{ url_for('my_certs.view', cert_id=existing_cert.cert_id) }}" class="btn btn-info btn-block">
                        <i class="fas fa-eye"></i> æŸ¥çœ‹è¯ä¹¦è¯¦æƒ…
                    </a>
                    {% else %}
                    <div class="row">
                        <div class="col-6">
                            <button type="submit" name="status" value="draft" class="btn btn-warning btn-block">
                                <i class="fas fa-save"></i> ä¿å­˜è‰ç¨¿
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="submit" name="status" value="submitted" class="btn btn-success btn-block">
                                <i class="fas fa-paper-plane"></i> æäº¤è¯ä¹¦
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block tail_js %}
<script>
    // æ˜¾ç¤ºloadingåŠ¨ç”»
    function showLoading(text, subtext) {
        $('#loadingText').text(text || 'æ­£åœ¨å¤„ç†ä¸­...');
        $('#loadingSubtext').text(subtext || 'è¯·ç¨å€™ï¼Œå³å°†å®Œæˆ');
        $('#loadingOverlay').css('display', 'flex');
    }

    // ä¸Šä¼ è¡¨å•æäº¤æ—¶æ˜¾ç¤ºloading
    $('#uploadForm').on('submit', function() {
        showLoading('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 'è¯·ç¨å€™ï¼Œæ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­');
    });

    // AIè¯†åˆ«è¡¨å•æäº¤æ—¶æ˜¾ç¤ºloading
    $('#extractForm').on('submit', function() {
        showLoading('ğŸ¤– AIæ­£åœ¨è¯†åˆ«è¯ä¹¦...', 'è¯·ç¨å€™ï¼Œæ™ºèƒ½è¯†åˆ«ä¸­ï¼Œé¢„è®¡éœ€è¦10-30ç§’');
    });

    // è‡ªå®šä¹‰æ–‡ä»¶è¾“å…¥æ˜¾ç¤ºæ–‡ä»¶å
    $('.custom-file-input').on('change', function () {
        var fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').addClass("selected").html(fileName);
    });

    // åˆå§‹åŒ– Select2
    $('.select2').select2({
        theme: 'bootstrap4',
        placeholder: 'è¯·é€‰æ‹©'
    });
</script>
{% endblock %}