{% extends 'admin/base.html' %}

{% block title %}è¯ä¹¦æ•°æ® - è¯ä¹¦ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}è¯ä¹¦æ•°æ®{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="#">è¯ä¹¦ç®¡ç†</a></li>
<li class="breadcrumb-item active">è¯ä¹¦æ•°æ®</li>
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <!-- è¯ä¹¦åˆ—è¡¨ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-list"></i> è¯ä¹¦åˆ—è¡¨</h3>
                <div class="card-tools">
                    <button onclick="exportCertificates()" class="btn btn-success btn-sm mr-2">
                        <i class="fas fa-file-excel"></i> å¯¼å‡ºExcel
                    </button>
                    <span class="badge badge-info">å…± {{ certificates|length }} æ¡è®°å½•</span>
                </div>
            </div>
            <div class="card-body">
                {% if certificates %}
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover datatable" data-manual-init>
                        <thead>
                            <tr>
                                <th>åºå·</th>
                                <th>å­¦å·</th>
                                <th>å§“å</th>
                                <th>ç«èµ›é¡¹ç›®</th>
                                <th>è·å¥–ç±»åˆ«</th>
                                <th>è·å¥–ç­‰çº§</th>
                                <th>ç«èµ›ç±»å‹</th>
                                <th>æ ‡å‡†åˆ†å€¼</th>
                                <th>è´¡çŒ®åº¦</th>
                                <th>çŠ¶æ€</th>
                                <th>æäº¤æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cert in certificates %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ cert.student_id }}</td>
                                <td>{{ cert.student_name }}</td>
                                <td>{{ cert.competition_name }}</td>
                                <td>{{ cert.award_category }}</td>
                                <td>{{ cert.award_level }}</td>
                                <td>{{ cert.competition_type }}</td>
                                <td>
                                    {% if cert.standard_score %}
                                    <span class="badge badge-success">{{ cert.standard_score }}</span>
                                    {% else %}
                                    <span class="text-muted">æœªè¯„åˆ†</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cert.contribution %}
                                    <span class="badge badge-info">{{ cert.contribution }}</span>
                                    {% else %}
                                    <span class="text-muted">æœªè¯„ä¼°</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cert.status == 'draft' %}
                                    <span class="badge badge-warning">ğŸ“ è‰ç¨¿</span>
                                    {% elif cert.status == 'pending_teacher' %}
                                    <span class="badge badge-info">â³ å¾…æ•™å¸ˆå®¡æ ¸</span>
                                    {% elif cert.status == 'pending_admin' %}
                                    <span class="badge badge-primary">â³ å¾…ç®¡ç†å‘˜å®¡æ ¸</span>
                                    {% elif cert.status == 'approved' %}
                                    <span class="badge badge-success">âœ… å®¡æ ¸é€šè¿‡</span>
                                    {% else %}
                                    <span class="badge badge-secondary">{{ cert.status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ cert.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <a href="{{ url_for('student_certs.edit', cert_id=cert.cert_id) }}"
                                        class="btn btn-sm btn-primary">
                                        <i class="fas fa-edit"></i> ç¼–è¾‘
                                    </a>
                                    {# è€å¸ˆåªèƒ½é€šè¿‡å¾…æ•™å¸ˆå®¡æ ¸çš„ï¼Œç®¡ç†å‘˜å’Œæ•™å­¦ç§˜ä¹¦å¯ä»¥é€šè¿‡ä»»æ„éå®¡æ ¸é€šè¿‡çŠ¶æ€çš„ï¼ˆæ•™å­¦ç§˜ä¹¦åªèƒ½å®¡æ ¸æœ¬é™¢ï¼‰ #}
                                    {% if current_user.role in ['admin', 'secretary'] and cert.status != 'approved' %}
                                        {% if current_user.role == 'secretary' and cert.department == current_user.department %}
                                        <a href="{{ url_for('student_certs.approve', cert_id=cert.cert_id) }}"
                                            class="btn btn-sm btn-success"
                                            onclick="return confirm('ç¡®å®šå®¡æ ¸é€šè¿‡è¯¥è¯ä¹¦å—ï¼Ÿ');">
                                            <i class="fas fa-check"></i> é€šè¿‡
                                        </a>
                                        {% elif current_user.role == 'admin' %}
                                        <a href="{{ url_for('student_certs.approve', cert_id=cert.cert_id) }}"
                                            class="btn btn-sm btn-success"
                                            onclick="return confirm('ç¡®å®šå®¡æ ¸é€šè¿‡è¯¥è¯ä¹¦å—ï¼Ÿ');">
                                            <i class="fas fa-check"></i> é€šè¿‡
                                        </a>
                                        {% endif %}
                                    {% elif current_user.role == 'teacher' and cert.status == 'pending_teacher' %}
                                    <a href="{{ url_for('student_certs.approve', cert_id=cert.cert_id) }}"
                                        class="btn btn-sm btn-success"
                                        onclick="return confirm('ç¡®å®šå®¡æ ¸é€šè¿‡è¯¥è¯ä¹¦å—ï¼Ÿé€šè¿‡åå°†è½¬äº¤ç®¡ç†å‘˜å®¡æ ¸ã€‚');">
                                        <i class="fas fa-check"></i> é€šè¿‡
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                    <p class="text-muted">æš‚æ— éœ€è¦å®¡æ ¸çš„è¯ä¹¦</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block tail_js %}
<script>
    $(function () {
        $('.datatable').DataTable({
            "language": {
                "url": "{{ url_for('static', filename='vendor/i18n/dataTables.zh.json') }}"
            },
            "order": [[10, "desc"]],
            "pageLength": 20
        });
    });

    // å¯¼å‡ºè¯ä¹¦æ•°æ®
    function exportCertificates() {
        window.location.href = '{{ url_for("student_certs.export") }}';
    }
</script>
{% endblock %}