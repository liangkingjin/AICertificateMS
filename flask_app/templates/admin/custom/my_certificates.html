{% extends 'admin/base.html' %}

{% block title %}æˆ‘çš„è¯ä¹¦ - è¯ä¹¦ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}æˆ‘çš„è¯ä¹¦{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="#">è¯ä¹¦ç®¡ç†</a></li>
<li class="breadcrumb-item active">æˆ‘çš„è¯ä¹¦</li>
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-certificate"></i> è¯ä¹¦åˆ—è¡¨</h3>
                <div class="card-tools">
                    <a href="{{ url_for('cert_upload.index') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> ä¸Šä¼ æ–°è¯ä¹¦
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if certificates %}
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover datatable" data-manual-init>
                        <thead>
                            <tr>
                                <th>åºå·</th>
                                <th>ç«èµ›é¡¹ç›®</th>
                                <th>è·å¥–ç±»åˆ«</th>
                                <th>è·å¥–ç­‰çº§</th>
                                <th>ç«èµ›ç±»å‹</th>
                                <th>æŒ‡å¯¼æ•™å¸ˆ</th>
                                {% if current_user.role not in ['student'] %}
                                <th>æ ‡å‡†åˆ†å€¼</th>
                                <th>è´¡çŒ®åº¦</th>
                                {% endif %}
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cert in certificates %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ cert.competition_name }}</td>
                                <td>{{ cert.award_category }}</td>
                                <td>{{ cert.award_level }}</td>
                                <td>{{ cert.competition_type }}</td>
                                <td>{{ cert.advisor }}</td>
                                {% if current_user.role not in ['student'] %}
                                <td>
                                    {% if cert.standard_score %}
                                    <span class="badge badge-success">{{ cert.standard_score }}</span>
                                    {% else %}
                                    <span class="text-muted">æœªè¯„åˆ†</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if cert.contribution %}
                                    <span class="badge badge-info">{{ cert.contribution }}</span>
                                    {% else %}
                                    <span class="text-muted">æœªè¯„ä¼°</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td>
                                    {% if cert.status == 'draft' %}
                                    <span class="badge badge-warning">ğŸ“ è‰ç¨¿</span>
                                    {% elif cert.status == 'pending_teacher' %}
                                    <span class="badge badge-info">â³ å¾…æ•™å¸ˆå®¡æ ¸</span>
                                    {% elif cert.status == 'pending_admin' %}
                                    <span class="badge badge-primary">â³ å¾…ç®¡ç†å‘˜å®¡æ ¸</span>
                                    {% elif cert.status == 'approved' %}
                                    <span class="badge badge-success">âœ… å®¡æ ¸é€šè¿‡</span>
                                    {% else %}
                                    <span class="badge badge-secondary">{{ cert.status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ cert.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if current_user.role == 'admin' %}
                                    {# ç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘ä»»ä½•çŠ¶æ€çš„è¯ä¹¦ #}
                                    <a href="{{ url_for('my_certs.edit', cert_id=cert.cert_id) }}"
                                        class="btn btn-sm btn-info">
                                        <i class="fas fa-edit"></i> ç¼–è¾‘
                                    </a>
                                    <form action="{{ url_for('my_certs.delete', cert_id=cert.cert_id) }}" method="post"
                                        style="display: inline;" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯ä¹¦å—ï¼Ÿ');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i> åˆ é™¤
                                        </button>
                                    </form>
                                    {% elif current_user.role == 'teacher' and cert.status in ['draft', 'pending_teacher'] %}
                                    {# æ•™å¸ˆå¯ä»¥ç¼–è¾‘è‰ç¨¿å’Œå¾…æ•™å¸ˆå®¡æ ¸çŠ¶æ€ #}
                                    <a href="{{ url_for('my_certs.edit', cert_id=cert.cert_id) }}"
                                        class="btn btn-sm btn-info">
                                        <i class="fas fa-edit"></i> ç¼–è¾‘
                                    </a>
                                    <form action="{{ url_for('my_certs.delete', cert_id=cert.cert_id) }}" method="post"
                                        style="display: inline;" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯ä¹¦å—ï¼Ÿ');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i> åˆ é™¤
                                        </button>
                                    </form>
                                    {% elif current_user.role == 'student' and cert.status == 'draft' %}
                                    {# å­¦ç”Ÿåªèƒ½ç¼–è¾‘è‰ç¨¿ #}
                                    <a href="{{ url_for('my_certs.edit', cert_id=cert.cert_id) }}"
                                        class="btn btn-sm btn-info">
                                        <i class="fas fa-edit"></i> ç¼–è¾‘
                                    </a>
                                    <form action="{{ url_for('my_certs.delete', cert_id=cert.cert_id) }}" method="post"
                                        style="display: inline;" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯ä¹¦å—ï¼Ÿ');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i> åˆ é™¤
                                        </button>
                                    </form>
                                    {% else %}
                                    <a href="{{ url_for('my_certs.view', cert_id=cert.cert_id) }}"
                                        class="btn btn-sm btn-secondary">
                                        <i class="fas fa-eye"></i> æŸ¥çœ‹
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                    <p class="text-muted">æ‚¨è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•è¯ä¹¦</p>
                    <a href="{{ url_for('cert_upload.index') }}" class="btn btn-primary">
                        <i class="fas fa-upload"></i> ç«‹å³ä¸Šä¼ 
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block tail_js %}
<script>
    $(function () {
        // æ ¹æ®ç”¨æˆ·è§’è‰²åŠ¨æ€è®¾ç½®æ’åºåˆ—
        // å­¦ç”Ÿï¼š9åˆ—ï¼ˆä¸å«è¯„åˆ†ï¼‰ï¼Œéå­¦ç”Ÿï¼š11åˆ—ï¼ˆå«è¯„åˆ†ï¼‰
        var orderColumn = {% if current_user.role == 'student' %}7{% else %}9{% endif %};

        $('.datatable').DataTable({
            "language": {
                "url": "{{ url_for('static', filename='vendor/i18n/dataTables.zh.json') }}"
            },
            "order": [[orderColumn, "desc"]],
            "pageLength": 10
        });
    });
</script>
{% endblock %}